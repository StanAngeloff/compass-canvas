#!/usr/bin/env ruby

require 'fileutils'
require 'rubygems'
require 'markdown'

__DIR = File.expand_path(File.join(File.dirname(__FILE__), '..'))

Dir.glob(File.join(__DIR, 'assets/**', 'example-*.png')).each do |image|
  File.unlink(image)
end

source = File.read(ARGV[0] || File.join(__DIR, 'index.md'))
index  = 1

source = source.gsub(/```(.*?)```/m) do |group|
  group = group.gsub(/```\s+|\s+```/, '').chomp
  local = group
  if group.match(/\n\/\//)
    group = group.gsub(/\n*(\n\/\/.*)+/) do |comments|
      local = comments.gsub(/^\/\//, '').chomp
      ''
    end
  end
  local = local.gsub(/\*\*/, '')
  local = local.gsub(/\bcanvas\(/, "canvas('example.png', ")
  File.open(File.join(__DIR, 'assets', 'example.scss'), 'wb') { |io| io << local }
  system("compass compile #{ File.join(__DIR, 'assets') } --force 1>/dev/null 2>&1")
  result = File.join(__DIR, 'assets', 'images', 'example.png')
  padd   = '    ';
  group  = padd + group.split("\n").join("\n#{padd}")
  if File.exists?(result)
    FileUtils.mv(result, File.join(__DIR, 'assets', 'images', "example-#{index}.png"))
    group = "<!-- div class='example' -->\n" + group + "\n![Example #{index}](assets/images/example-#{index}.png)" + "\n\n<!-- /div -->"
    index = index + 1
  end
  group
end

File.open(File.join(__DIR, 'assets', 'example.scss'), 'wb') { |io| io << '' }
if File.exists?(File.join(__DIR, 'assets', 'example.css'))
  File.unlink(File.join(__DIR, 'assets', 'example.css'))
end

source = Markdown.new(source).to_html
source = source.gsub("<!-- div class='example' -->", '<div class="example">');
source = source.gsub("<!-- /div -->", '</div>');
source = source.gsub(/\*\*(.*?)\*\*/, '<strong>\1</strong>')

puts <<-EOD
<!doctype html>
<html>
<head>
  <title>compass-canvas</title>
  <link rel=stylesheet href=assets/default.css>
</head>
<body>

<a href="https://github.com/StanAngeloff/compass-canvas/"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://a248.e.akamai.net/assets.github.com/img/7afbc8b248c68eb468279e8c17986ad46549fb71/687474703a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6461726b626c75655f3132313632312e706e67" alt="Fork me on GitHub"></a>

<article id=main>
#{ source }
</article>

</body>
</html>
EOD
